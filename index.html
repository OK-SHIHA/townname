<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>市区町村→都道府県クイズ</title>
<style>
  :root{
    /* iPadでもスクロール不要なサイズ感に調整 */
    --tile: clamp(22px, 3.6vw, 40px);
    --gap: clamp(1px, 0.4vw, 6px);

    --bg:#0f1120; --panel:#161a2d; --panel-2:#1a2142; --text:#f4f6ff; --muted:#aab1d1;

    /* 地方カラー */
    --c-hokkaido:#8ba0ff; --c-tohoku:#8fb5ff; --c-kanto:#7fd7e8;
    --c-chubu:#b8f274; --c-kinki:#f4ee77; --c-chugoku:#ffc98e;
    --c-shikoku:#ffb3b3; --c-kyushu:#f3a1f3;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",Meiryo,sans-serif;
    background:radial-gradient(900px 520px at 70% -10%, #26315a 0%, #12162c 45%, #0b0e1a 100%), #0c0f1c;
    display:flex; flex-direction:column; align-items:center; gap:10px; padding:8px;
  }
  h1{font-size:clamp(16px,3.2vw,22px); margin:0; font-weight:800}

  /* 枠（左右ペイン）をコンパクト化 */
  .app{width:min(920px,98vw); display:grid; gap:8px; grid-template-columns:320px 1fr}
  @media (max-width:860px){.app{grid-template-columns:1fr}}

  .panel{background:linear-gradient(180deg,var(--panel),#12162b); border:1px solid #212642; border-radius:12px; padding:10px}

  .controls{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .btn{appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer;background:#3150ff;color:#fff}
  .btn.secondary{background:#222a55;border:1px solid #36408a}
  .btn.ghost{background:transparent;border:1px dashed #2e3566;color:#d8dcff}
  .select,.select2{display:flex;align-items:center;gap:6px;background:#151b36;border:1px solid #2a3260;border-radius:10px;padding:6px 8px;color:#e8ecff}
  .select2{background:#121636}
  select{background:transparent;border:none;color:#e8ecff;font-weight:700;outline:none}

  .status{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px}
  .stat{background:#121739;border:1px solid #2b3365;border-radius:10px;padding:6px 8px}
  .stat .k{font-size:11px;color:var(--muted)}
  .stat .v{font-weight:900;font-size:18px}

  .tabs{display:flex;gap:6px;margin-bottom:6px}
  .tab{flex:1;text-align:center;padding:8px;border-radius:10px;border:1px solid #2b3365;background:#121739;cursor:pointer}
  .tab.active{background:#1a2362;border-color:#4a64ff}

  /* === タイル地図 === */
  .map-wrap{display:flex;flex-direction:column;gap:6px}
  .legend{font-size:12px;color:#aab1d1}

  .grid{
    --cols:20; --rows:17;
    position:relative;
    display:grid;
    grid-template-columns:repeat(var(--cols),var(--tile));
    grid-template-rows:repeat(var(--rows),var(--tile));
    gap:var(--gap); justify-content:center;
    background:linear-gradient(180deg,var(--panel-2),#121634);
    border:1px solid #22294f;border-radius:10px;
    padding:6px;             /* ← 余白縮小（上下左右） */
    overflow:hidden;
    min-height:unset;        /* ← 固定高さを撤廃してスクロール回避 */
  }

  .tile{
    z-index:1;
    border-radius:7px; border:1px solid rgba(0,0,0,.08);
    box-shadow:0 1px 0 rgba(255,255,255,.35) inset, 0 2px 6px rgba(0,0,0,.08);
    display:flex; align-items:center; justify-content:center;
    font-weight:800; font-size:clamp(10px,1.25vw,14px); color:#1a2350;
    user-select:none; cursor:pointer; transition:transform .06s ease, filter .12s ease, box-shadow .12s ease;
    background:#e7ecff;
  }
  .tile:hover{transform:translateY(-1px); filter:brightness(1.02)}

  /* 地方色（保持） */
  .hokkaido{background:var(--c-hokkaido)}
  .tohoku{background:var(--c-tohoku)}
  .kanto{background:var(--c-kanto)}
  .chubu{background:var(--c-chubu)}
  .kinki{background:var(--c-kinki)}
  .chugoku{background:var(--c-chugoku)}
  .shikoku{background:var(--c-shikoku)}
  .kyushu{background:var(--c-kyushu)}

  /* 視認性の高い強調（正解 / 不正解） */
  .tile.correct { outline:4px solid #00e676 !important; background:#a5ffcf !important; animation:blinkCorrect .8s ease-in-out 2; z-index:10; }
  .tile.wrong   { outline:3px solid #ff1744 !important; background:#ffb3b3 !important; animation:blinkWrong .8s ease-in-out 1; z-index:10; }
  @keyframes blinkCorrect { 0%,100%{filter:brightness(1)} 50%{filter:brightness(2)} }
  @keyframes blinkWrong   { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.6)} }

  /* 出題オーバーレイ：日本海側（やや左上）に戻す */
  .prompt-overlay{
    position:absolute; z-index:3; pointer-events:none;
    grid-column: 5 / span 8;     /* ← さらに日本海側へ寄せる */
    grid-row: 6 / span 6;
    display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;
  }
  /* ふりがなを上、漢字を下に（ご指定） */
  .prompt-kana{font-weight:700; font-size:clamp(12px,2.0vw,18px); color:#d9e1ff; opacity:0.95; letter-spacing:.02em}
  .prompt-title{margin-top:2px; font-weight:900; line-height:1.05; font-size:clamp(24px, 5.0vw, 48px); color:#ffffff; text-shadow:0 2px 10px rgba(0,0,0,.35)}
  .prompt-note{margin-top:4px; font-size:clamp(11px,1.8vw,14px); color:#e0e6ff; opacity:.9}
  .prompt-result{margin-top:6px; padding:4px 8px; border-radius:8px; font-weight:800; font-size:clamp(12px,2.0vw,18px); background:#0f163388; color:#eaf5ff; border:1px solid #293166; visibility:hidden}
  .prompt-result.ok{background:#0f2a2088; border-color:#2a7a59; color:#caffea}
  .prompt-result.ng{background:#2a0f1788; border-color:#94364c; color:#ffdbe0}
</style>
</head>
<body>
<h1>市区町村→都道府県クイズ</h1>

<div class="app">
  <section class="panel">
    <div class="tabs">
      <div id="tabGame" class="tab active">ゲーム</div>
      <div id="tabHist" class="tab">履歴</div>
    </div>

    <div id="gameView">
      <div class="controls" style="margin-bottom:6px">
        <div class="select">
          <span>出題:</span>
          <select id="mode">
            <option value="all" selected>全市区町村（全国）</option>
            <option value="cities">市だけ（区・町・村を除外）</option>
            <option value="review">復習（前回の間違い）</option>
          </select>
        </div>
        <div class="select2">
          <span>問題数:</span>
          <select id="limit">
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="0">無制限</option>
          </select>
        </div>
        <button class="btn secondary" id="skipBtn">スキップ</button>
        <button class="btn ghost" id="restartBtn">やり直し</button>
      </div>

      <div class="status">
        <div class="stat"><div class="k">正解</div><div class="v" id="correct">0</div></div>
        <div class="stat"><div class="k">連続正解</div><div class="v" id="streak">0</div></div>
        <div class="stat"><div class="k">正答率</div><div class="v" id="acc">—</div></div>
      </div>
    </div>

    <div id="histView" style="display:none">
      <div class="controls" style="margin:6px 0">
        <div class="select"><span>対象:</span>
          <select id="histScope"><option value="latest" selected>最新セッション</option><option value="all">全期間</option></select>
        </div>
        <div class="select"><span>絞込:</span>
          <select id="histFilter"><option value="all">すべて</option><option value="ok">正解のみ</option><option value="ng">不正解のみ</option></select>
        </div>
        <button class="btn secondary" id="exportCsv">CSV</button>
        <button class="btn secondary" id="exportJson">JSON</button>
        <button class="btn ghost" id="clearLatest">最新セッション削除</button>
        <button class="btn ghost" id="clearAll">全履歴削除</button>
      </div>
      <div style="max-height:320px;overflow:auto;border:1px solid #2b3365;border-radius:10px">
        <table id="histTable" style="width:100%;border-collapse:collapse;font-size:13px">
          <thead><tr><th>#</th><th>市区町村</th><th>都道府県</th><th>正誤</th><th>時刻</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn" id="startReview">この履歴から復習</button>
      </div>
    </div>
  </section>

  <section class="panel map-wrap">
    <div class="legend">20×17 グリッド（日本海側に出題表示）</div>
    <div id="grid" class="grid" aria-label="日本の都道府県タイル地図">
      <div class="prompt-overlay">
        <!-- ふりがなを上、漢字を下 -->
        <div id="promptKana" class="prompt-kana"></div>
        <div id="promptBig" class="prompt-title">—</div>
        <div id="promptNote" class="prompt-note"></div>
        <div id="promptResult" class="prompt-result">—</div>
      </div>
    </div>
  </section>
</div>

<script>
/* ====== 指定の座標と大きさ（0-based） ====== */
const PREF_POS = {
  "北海道":[15,3],
  "青森県":[15,4], "秋田県":[15,5], "岩手県":[16,5],
  "山形県":[15,6], "宮城県":[16,6], "福島県":[15,7],

  "茨城県":[16,8], "栃木県":[15,8], "群馬県":[14,8],
  "埼玉県":[15,9], "千葉県":[16,9], "東京都":[15,10], "神奈川県":[14,10],

  "新潟県":[13,7], "富山県":[12,7], "石川県":[11,6], "福井県":[11,8],
  "長野県":[13,8], "山梨県":[14,9], "静岡県":[13,10],
  "岐阜県":[12,8], "愛知県":[12,10], "三重県":[11,11],

  "滋賀県":[11,9], "京都府":[10,9], "大阪府":[10,10],
  "兵庫県":[9,9], "奈良県":[11,10], "和歌山県":[10,11],

  "鳥取県":[8,9], "島根県":[7,9], "岡山県":[8,10],
  "広島県":[7,10], "山口県":[6,10],

  "香川県":[8,12], "徳島県":[8,13], "愛媛県":[7,12], "高知県":[7,13],

  "福岡県":[5,10], "佐賀県":[4,10], "長崎県":[4,11], "大分県":[5,11],
  "熊本県":[4,12], "宮崎県":[5,12], "鹿児島県":[4,13],

  "沖縄県":[5,8]
};

const PREF_SPAN = {
  /* 横長（2×1） */
  "北海道":[2,1], "青森県":[2,1], "福島県":[2,1], "新潟県":[2,1], "鹿児島県":[2,1],
  /* 縦長（1×2） */
  "千葉県":[1,2], "長野県":[1,2], "岐阜県":[1,2], "石川県":[1,2], "兵庫県":[1,2]
};

/* 地方→色クラス */
const PREF_REGION={
  "北海道":"hokkaido",
  "青森県":"tohoku","岩手県":"tohoku","秋田県":"tohoku","宮城県":"tohoku","山形県":"tohoku","福島県":"tohoku",
  "茨城県":"kanto","栃木県":"kanto","群馬県":"kanto","埼玉県":"kanto","千葉県":"kanto","東京都":"kanto","神奈川県":"kanto",
  "新潟県":"chubu","富山県":"chubu","石川県":"chubu","福井県":"chubu","長野県":"chubu","山梨県":"chubu","静岡県":"chubu","岐阜県":"chubu","愛知県":"chubu","三重県":"chubu",
  "滋賀県":"kinki","京都府":"kinki","大阪府":"kinki","兵庫県":"kinki","奈良県":"kinki","和歌山県":"kinki",
  "鳥取県":"chugoku","島根県":"chugoku","岡山県":"chugoku","広島県":"chugoku","山口県":"chugoku",
  "香川県":"shikoku","徳島県":"shikoku","愛媛県":"shikoku","高知県":"shikoku",
  "福岡県":"kyushu","佐賀県":"kyushu","長崎県":"kyushu","大分県":"kyushu","熊本県":"kyushu","宮崎県":"kyushu","鹿児島県":"kyushu","沖縄県":"kyushu"
};

/* ====== 同名自治体（複数都道府県に存在）への注釈リスト ======
   例：美浜町 → 福井・愛知・和歌山
   表示：福井県の美浜町を出題時は「美浜町（愛知、和歌山でない）」と注記
*/
const AMBIGUOUS = {
  // 区分: 市 / 町 / 村（参考。使うのは名称→都道府県配列）
  "府中市": ["東京都","広島県"],
  "伊達市": ["北海道","福島県"],
  "朝日町": ["山形県","富山県","三重県"],
  "池田町": ["北海道","福井県","岐阜県","長野県"],
  "小国町": ["山形県","熊本県"],
  "金山町": ["山形県","福島県"],
  "川崎町": ["宮城県","福岡県"],
  "川西町": ["奈良県","山形県"],
  "清水町": ["北海道","静岡県"],
  "太子町": ["大阪府","兵庫県"],
  "高森町": ["長野県","熊本県"],
  "南部町": ["青森県","鳥取県","山梨県"],
  "日高町": ["北海道","和歌山県"],
  "日野町": ["滋賀県","鳥取県"],
  "広川町": ["和歌山県","福岡県"],
  "松前町": ["愛媛県","北海道"],
  "美里町": ["宮城県","埼玉県","熊本県"],
  "美郷町": ["秋田県","島根県","宮崎県"],
  "美浜町": ["福井県","愛知県","和歌山県"],
  "明和町": ["三重県","群馬県"],
  "森町": ["北海道","静岡県"],
  "川上村": ["長野県","奈良県"],
  "昭和村": ["福島県","群馬県"],
  "高山村": ["群馬県","長野県"],
  "泊村": ["北海道（後志管内）","北海道（根室管内）"],
  "南牧村": ["群馬県","長野県"]
};

/* ====== Wikidataから市区町村＋かな(P1814)取得 ====== */
const WD={endpoint:"https://query.wikidata.org/sparql",sparql:
`SELECT ?muni ?muniLabel ?prefLabel ?kana WHERE {
  VALUES ?typ { wd:Q494721 wd:Q5327704 wd:Q1059478 wd:Q4174776 } # 市・特別区・町・村
  ?muni wdt:P31/wdt:P279* ?typ .
  ?muni wdt:P131 ?pref .
  ?pref wdt:P31 wd:Q50337 .
  OPTIONAL { ?muni wdt:P1814 ?kana . }  # かな表記
  SERVICE wikibase:label { bd:serviceParam wikibase:language "ja". }
}`};
const LS_DATA="JP_MUNI_ALL_with_kana_v3";
const LS_HIST="JP_MUNI_HISTORY_v1";

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function fetchWithTimeout(resource, options){
  const controller=new AbortController();
  const to=(options && options.timeout) ? options.timeout : 15000;
  const id=setTimeout(()=>controller.abort(), to);
  try{
    return await fetch(resource,{
      ...options,
      signal:controller.signal,
      headers:{'Accept':'application/sparql-results+json'}
    });
  }finally{ clearTimeout(id); }
}

async function getMunicipalities(){
  const cached=localStorage.getItem(LS_DATA);
  if(cached){ try{ return JSON.parse(cached); }catch(_e){} }
  const url=WD.endpoint + "?format=json&query=" + encodeURIComponent(WD.sparql);
  let res, data;
  for(let attempt=0; attempt<2; attempt++){
    try{
      res = await fetchWithTimeout(url,{timeout:15000,cache:'no-store'});
      if(!res.ok) throw new Error("HTTP "+res.status);
      data = await res.json();
      break;
    }catch(e){
      if(attempt===1) throw e;
      await sleep(1000);
    }
  }
  const map = {};
  const rows = (data && data.results && data.results.bindings) ? data.results.bindings : [];
  for(const r of rows){
    const pref = r.prefLabel.value;
    const name = r.muniLabel.value;
    const kana = (r.kana && r.kana.value) ? r.kana.value : "";
    if(!map[pref]) map[pref]=[];
    if(!map[pref].some(x=>x.name===name)){
      map[pref].push({name:name, kana:kana});
    }
  }
  for(const k in map){
    map[k].sort((a,b)=> a.name.localeCompare(b.name, 'ja'));
  }
  localStorage.setItem(LS_DATA, JSON.stringify(map));
  return map;
}

/* ====== ゲーム状態・履歴 ====== */
let MUNI_BY_PREF={}, pool=[], current=null;
let answered=0, correct=0, streak=0, autoTimer=null;
let sessionLog=[], sessionLimit=20, sessionStartedAt=null;

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;}
function prefLabelShort(p){ if(p==="北海道")return"北海道"; if(p==="東京都")return"東京"; return p.replace(/(県|府)$/,''); }

/* 注釈の生成：AMBIGUOUSに載っていれば「（他県でない）」を表示 */
function makeAmbiguousNote(name, pref){
  const list = AMBIGUOUS[name];
  if(!list) return "";
  // 同名の中に今回のprefが含まれていないケース（例：泊村の表記など）は一旦注釈なしにする
  if(!list.some(p=>p===pref)) return "";
  const others = list.filter(p=>p!==pref);
  if(others.length===0) return "";
  return `${name}（${others.join("、")}でない）`;
}

function setPrompt(q){
  const elKana=document.getElementById('promptKana');
  const elTitle=document.getElementById('promptBig');
  const elNote=document.getElementById('promptNote');
  elKana.textContent = q?.kana || "";
  elTitle.textContent = q?.name || "—";
  elNote.textContent = q ? makeAmbiguousNote(q.name, q.pref) : "";
}
function setResult(t,cls){
  const el=document.getElementById('promptResult');
  el.textContent=t;
  el.className='prompt-result ' + (cls||'');
  el.style.visibility='visible';
}
function clearResult(){
  const el=document.getElementById('promptResult');
  el.textContent='';
  el.className='prompt-result';
  el.style.visibility='hidden';
}

/* 履歴：読み込み／レンダリング */
function loadHistory(){ const raw=localStorage.getItem(LS_HIST); if(!raw) return []; try{ return JSON.parse(raw); }catch(_e){ return []; } }
function renderHistory(){
  const scope=document.getElementById('histScope').value;
  const filter=document.getElementById('histFilter').value;
  const tbody=document.querySelector('#histTable tbody');
  tbody.innerHTML='';
  const hist=loadHistory();
  let rows=[];
  if(scope==='latest'){ const last=hist.at(-1); if(last){ rows=last.items.map((x,i)=>({...x,idx:i+1})); } }
  else { let i=1; for(const h of hist){ for(const x of h.items){ rows.push({...x,idx:i++}); } } }
  if(filter==='ok') rows = rows.filter(r=>r.correct);
  if(filter==='ng') rows = rows.filter(r=>!r.correct);
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.idx}</td>
      <td>${r.name}${r.kana?`<br><small style="opacity:.75">${r.kana}</small>`:''}</td>
      <td>${r.pref}</td>
      <td style="font-weight:700;color:${r.correct?'#2ac48a':'#ff5d73'}">${r.correct?'○':'×'}</td>
      <td>${new Date(r.at).toLocaleString()}</td>`;
    tbody.appendChild(tr);
  }
}

/* セッション制御（逐次保存） */
function openNewSessionAt(tsISO){
  const all = loadHistory();
  all.push({ startedAt: tsISO, finishedAt: null, items: [] });
  localStorage.setItem(LS_HIST, JSON.stringify(all));
}
function persistLatestIncremental(){
  const all = loadHistory();
  if(all.length === 0) return;
  const last = all[all.length - 1];
  last.items = sessionLog.slice();
  last.finishedAt = new Date().toISOString();
  localStorage.setItem(LS_HIST, JSON.stringify(all));
  if(document.getElementById('histView').style.display !== 'none'){ renderHistory(); }
}
function endSession(){
  const all = loadHistory();
  if(all.length){
    all[all.length-1].finishedAt = new Date().toISOString();
    localStorage.setItem(LS_HIST, JSON.stringify(all));
  }
  switchToHist();
  renderHistory();
}

/* プール構築 */
function buildPool(mode){
  const arr=[];
  if(mode==="review"){
    const last = loadHistory().at(-1);
    if(last){
      last.items.filter(x=>!x.correct).forEach(x=>arr.push({name:x.name,kana:x.kana||"",pref:x.pref}));
    }
  }else{
    for(const pref in PREF_POS){
      let list = MUNI_BY_PREF[pref] || []; // [{name,kana}]
      if(mode==="cities"){ list = list.filter(it=> it.name.endsWith("市")); }
      for(const it of list){ arr.push({name:it.name,kana:it.kana||"",pref:pref}); }
    }
  }
  return shuffle(arr);
}

/* 出題制御 */
function nextQuestion(){
  if(sessionLimit>0 && sessionLog.length>=sessionLimit){ endSession(); return; }
  if(pool.length===0){
    pool = buildPool(document.getElementById('mode').value);
    if(pool.length===0){ setPrompt({name:"復習対象がありません",kana:"",pref:""}); clearResult(); return; }
  }
  current = pool.pop();
  setPrompt(current);
  clearResult();
  document.querySelectorAll('.tile').forEach(t=>t.classList.remove('correct','wrong'));
}

/* ステータス更新 */
function updateStats(){
  document.getElementById('correct').textContent = String(correct);
  document.getElementById('streak').textContent = String(streak);
  document.getElementById('acc').textContent = answered ? (Math.round(correct/answered*100)+'%') : '—';
}

/* 回答処理：回答ごとに履歴へ保存 */
function onAnswer(pref, tile){
  if(!current) return;
  if(autoTimer){ clearTimeout(autoTimer); autoTimer=null; }
  answered++;
  const ok = (pref===current.pref);
  if(ok){
    correct++; streak++; tile.classList.add('correct');
    setResult(`正解！『${current.name}』は『${current.pref}』`,'ok');
  }else{
    streak=0; tile.classList.add('wrong');
    const rt=[...document.querySelectorAll('.tile')].find(t=>t.dataset.pref===current.pref);
    if(rt) rt.classList.add('correct');
    setResult(`残念…『${current.name}』は『${current.pref}』`,'ng');
  }
  updateStats();
  sessionLog.push({name:current.name,kana:current.kana||"",pref:current.pref,correct:ok,at:new Date().toISOString()});
  persistLatestIncremental();
  autoTimer=setTimeout(()=>{ nextQuestion(); autoTimer=null; }, 1000);
}

/* ====== UI配線 ====== */
function switchToHist(){
  document.getElementById('tabGame').classList.remove('active');
  document.getElementById('tabHist').classList.add('active');
  document.getElementById('gameView').style.display='none';
  document.getElementById('histView').style.display='block';
}
function switchToGame(){
  document.getElementById('tabGame').classList.add('active');
  document.getElementById('tabHist').classList.remove('active');
  document.getElementById('gameView').style.display='block';
  document.getElementById('histView').style.display='none';
}
function updateSessionLimit(){ const v=parseInt(document.getElementById('limit').value,10); sessionLimit = isNaN(v)?20:v; }
function resetStats(){ answered=0; correct=0; streak=0; sessionLog=[]; updateStats(); }
function restart(){
  if(autoTimer){clearTimeout(autoTimer); autoTimer=null;}
  resetStats();
  updateSessionLimit();
  pool = buildPool(document.getElementById('mode').value);
  sessionStartedAt = new Date().toISOString();
  openNewSessionAt(sessionStartedAt);
  nextQuestion();
}

/* ====== タイルDOM生成（0→1基準） ====== */
const grid=document.getElementById('grid');
function buildTiles(){
  for(const pref in PREF_POS){
    const pos=PREF_POS[pref];
    const span=PREF_SPAN[pref]||[1,1];
    const [x,y]=pos, [w,h]=span;
    const b=document.createElement('button');
    b.type='button';
    b.className='tile ' + (PREF_REGION[pref]||'');
    b.dataset.pref=pref; b.title=pref;
    b.style.gridColumn = (x+1) + " / span " + w;
    b.style.gridRow = (y+1) + " / span " + h;
    b.textContent = prefLabelShort(pref);
    b.addEventListener('click', ()=> onAnswer(pref, b));
    grid.appendChild(b);
  }
}

/* ボタン・タブ */
document.getElementById('tabGame').onclick = switchToGame;
document.getElementById('tabHist').onclick = function(){ switchToHist(); renderHistory(); };
document.getElementById('histScope').onchange = renderHistory;
document.getElementById('histFilter').onchange = renderHistory;

document.getElementById('exportCsv').onclick = exportCsv;
document.getElementById('exportJson').onclick = exportJson;
document.getElementById('clearLatest').onclick = clearLatest;
document.getElementById('clearAll').onclick = clearAll;
document.getElementById('startReview').onclick = startReviewFromHistory;

document.getElementById('mode').onchange = restart;
document.getElementById('limit').onchange = updateSessionLimit;
document.getElementById('restartBtn').onclick = restart;
document.getElementById('skipBtn').onclick = function(){ if(autoTimer){clearTimeout(autoTimer); autoTimer=null;} setResult('スキップしました',''); nextQuestion(); };

/* 履歴ユーティリティ */
function exportCsv(){
  const h=loadHistory();
  const lines=['session,start,finish,index,name,kana,pref,correct,timestamp'];
  h.forEach((s,si)=> s.items.forEach((x,i)=>{
    const line=[si+1, s.startedAt||'', s.finishedAt||'', i+1, `"${x.name}"`, `"${x.kana||""}"`, `"${x.pref}"`, x.correct?1:0, x.at].join(',');
    lines.push(line);
  }));
  const blob=new Blob([lines.join('\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='jp_quiz_history.csv'; a.click();
}
function exportJson(){
  const blob=new Blob([localStorage.getItem(LS_HIST)||'[]'],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='jp_quiz_history.json'; a.click();
}
function clearLatest(){
  const h=loadHistory(); h.pop(); localStorage.setItem(LS_HIST, JSON.stringify(h)); renderHistory();
}
function clearAll(){
  if(!confirm('全履歴を削除します。よろしいですか？')) return;
  localStorage.removeItem(LS_HIST); renderHistory();
}
function startReviewFromHistory(){ document.getElementById('mode').value='review'; switchToGame(); restart(); }

/* ====== 起動 ====== */
buildTiles();
(async function init(){
  setPrompt({name:"全国の市区町村を取得中…", kana:"", pref:""});
  clearResult();
  try{
    MUNI_BY_PREF = await getMunicipalities();
    restart();
  }catch(e){
    console.error(e);
    setPrompt({name:"データ取得に失敗。再読み込みしてください。", kana:"", pref:""});
  }
})();
</script>
</body>
</html>
